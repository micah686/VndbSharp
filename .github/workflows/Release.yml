name: Publish VndbSharp Packages

on:
  push:
    branches: [ gha ]
  pull_request:
    branches: [ gha ]
  
env:
  PROJECT_NAME: VndbSharp
  GITHUB_FEED: https://nuget.pkg.github.com/micah686/index.json
  GITHUB_USER: micah686
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  NUGET_FEED: https://api.nuget.org/v3/index.json
  NUGET_KEY: ${{secrets.NUGET_API_KEY}}

jobs:
  build:
    runs-on: windows-latest
    continue-on-error: true
    steps:

    - uses: actions/checkout@v1

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 2.2.109
    - name: dotnet build
      run: |
        mkdir ${{ github.workspace }}/build
        dotnet build VndbSharp/VndbSharp.csproj -c Release -o --output ${{ github.workspace }}/build
        dir ${{ github.workspace }}/build
    - name: Install NuGet client
      uses: warrenbuckley/Setup-Nuget@v1

    - name: Push with dotnet
      run: dotnet nuget push .${{ github.workspace }}/build/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json
   
    - name: Push with dotnet2
      run: dotnet nuget push ${{ github.workspace }}/build/*.nupkg -k ${{ secrets.NUGET_API_KEY }} -s https://api.nuget.org/v3/index.json 

    - name: Push with nuget
      run: |
        nuget ${{secrets.NUGET_API_KEY}}
        nuget push ${{ github.workspace }}/build/*.nupkg -Source https://api.nuget.org/v3/index.json
      
    - name: Publish to NuGet
      uses: brandedoutcast/publish-nuget@v2
      with:
        PROJECT_FILE_PATH: VndbSharp/VndbSharp.csproj
        VERSION_REGEX: '^\s*<PackageVersion>(.*)<\/PackageVersion>\s*$'
        TAG_FORMAT: '*'
        NUGET_KEY: ${{secrets.NUGET_API_KEY}}
